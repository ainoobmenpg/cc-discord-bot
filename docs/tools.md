# ツール（Tools）仕様

GLM-4.7が自動的に使用できるツールの一覧と仕様です。

---

## 概要

ツールはGLM-4.7が自律的に呼び出して実行する機能です。ユーザーは `/ask` コマンドで自然言語で指示するだけで、LLMが必要なツールを選択して実行します。

---

## ファイル操作ツール

### `read_file` - ファイル読み取り

ファイルの内容を読み取ります。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `path` | string | ✅ | 読み取るファイルの相対パス |

**制限**:
- 相対パスのみ（絶対パスは禁止）
- 親ディレクトリ参照（`..`）は禁止
- シンボリックリンクは禁止

**使用例**:
```
ユーザー: config.txtの内容を表示して
→ LLMが read_file(path="config.txt") を実行
```

---

### `write_file` - ファイル書き込み

ファイルに内容を書き込みます。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `path` | string | ✅ | 書き込むファイルの相対パス |
| `content` | string | ✅ | 書き込む内容 |

**出力先**:
```
output/{YYYY-MM-DD}/user_{user_id}/{path}
```

**制限**:
- 相対パスのみ
- 親ディレクトリ参照（`..`）は禁止
- シンボリックリンクは禁止

---

### `edit_file` - ファイル部分編集

ファイルの一部を置換します。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `path` | string | ✅ | 編集するファイルの相対パス |
| `old_string` | string | ✅ | 置換対象の文字列 |
| `new_string` | string | ✅ | 置換後の文字列 |
| `replace_all` | boolean | | 全て置換するか（デフォルト: false） |

**注意**:
- `replace_all: false` の場合、`old_string` は一意である必要があります
- 複数マッチする場合は `replace_all: true` を使用

---

### `list_files` - ファイル一覧

ディレクトリのファイル一覧を表示します。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `path` | string | | ディレクトリパス（デフォルト: .） |

**出力形式**:
```
Directories:
  dir1/
  dir2/

Files:
  file1.txt
  file2.py
```

---

### `glob` - パターンマッチ検索

ファイル名パターンで検索します。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `pattern` | string | ✅ | globパターン |
| `path` | string | | 検索開始ディレクトリ |

**パターン例**:
- `*.txt` - 全ての.txtファイル
- `**/*.rs` - 全ディレクトリの.rsファイル
- `src/**/*.rs` - src配下の.rsファイル

---

### `grep` - 内容検索

ファイル内容を正規表現で検索します。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `pattern` | string | ✅ | 正規表現パターン |
| `path` | string | | 検索ディレクトリ |
| `glob` | string | | ファイルパターン |

**使用例**:
```
ユーザー: TODOコメントを探して
→ grep(pattern="TODO", glob="*.rs")
```

---

## シェルツール

### `bash` - コマンド実行

シェルコマンドを実行します。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `command` | string | ✅ | 実行するコマンド |
| `timeout` | integer | | タイムアウト秒（デフォルト: 30、最大: 60） |

**制限（ブロックされるコマンド）**:
- `rm -rf /`
- `sudo`, `su`
- `eval`, `exec`
- `base64 -d`（難読化実行）
- コマンド置換 `$()`, バッククォート
- その他危険なパターン

**環境**:
- Windows: PowerShell
- Unix: sh

**作業ディレクトリ**:
```
output/{YYYY-MM-DD}/user_{user_id}/
```

---

## Webツール

### `web_fetch` - Webコンテンツ取得

Webページの内容を取得します。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `url` | string | ✅ | 取得するURL |

**機能**:
- 本文抽出（readabilityアルゴリズム）
- メタデータ取得（タイトル、説明）
- ナビゲーション・広告除外

**出力形式**:
```markdown
# ページタイトル

> URL: https://example.com
> 取得日時: 2026-02-21

本文内容...
```

---

## メモリツール

### `remember` - メモリ保存

長期記憶として情報を保存します。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `content` | string | ✅ | 保存する内容 |
| `category` | string | | カテゴリ |
| `tags` | array | | タグ |

**使用例**:
```
ユーザー: 私の好きな色は青です。覚えておいて
→ remember(content="好きな色は青", tags=["preference"])
```

---

### `recall` - メモリ検索

保存したメモリを検索します。

**パラメータ**:
| 名前 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| `query` | string | ✅ | 検索クエリ |
| `limit` | integer | | 結果数上限（デフォルト: 5） |

**使用例**:
```
ユーザー: 私の好きな色は何？
→ recall(query="好きな色")
```

---

## MCPツール（拡張）

MCP（Model Context Protocol）経由で外部ツールを統合できます。

**設定**:
```bash
# .env
MCP_CONFIG_PATH=/path/to/mcp-config.json
```

**mcp-config.json例**:
```json
{
  "servers": [
    {
      "name": "filesystem",
      "command": "mcp-filesystem",
      "args": ["/allowed/path"]
    }
  ]
}
```

---

## セキュリティ

### 全ツール共通のセキュリティ対策

1. **パストラバーサル対策**
   - `..` の使用禁止
   - 絶対パス禁止

2. **シンボリックリンク対策**
   - symlinkの検出とブロック

3. **入力バリデーション**
   - XSS対策（HTMLエスケープ）
   - 制御文字の除去

4. **エラー情報の保護**
   - 内部パス情報の隠蔽
   - 一般的なエラーメッセージ

### レートリミット

- 1ユーザーあたり1分間に10リクエスト
- 超過時はリトライ時間を通知
